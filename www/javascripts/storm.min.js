(function(){var t,e;window.Storm=t={},t.bolts={},t.keywords={},t.init=function(e){return new t.Bar($(e))},t.install=function(e){return $.get(e,null,function(r){return t.load(t.idFromURL(e),r)},"text")},t.idFromURL=function(t){return""+CryptoJS.SHA1(t)},t.load=function(e,r){var n;return n=new t.Bolt(e,r),t.register(n)},t.register=function(e){return t.bolts[e.id]=e,t.keywords[e.getKeyword()]=t.keywords[e.getKeyword()]||[],t.keywords[e.getKeyword()].push(e.id)},t.terminateAll=function(){var e,r,n,i;n=t.bolts,i=[];for(r in n)e=n[r],i.push(e.terminate());return i},t.utils={prefixMatch:function(t,e){return 0===e.search(RegExp("^"+t,"i"))},fuzzyMatch:function(t,e,r){return null==r&&(r=0),e.score(t)>r}},t.actions={repeat:function(){return function(t){return t.update(!0)}},open:function(t){return function(){return window.open(t)}},fill:function(t){return function(e){return e.forceSearchTerm(t)}},fillKeyword:function(t){return function(e){return e.forceSearchTerm(t+" ")}},fillCommand:function(t,e){return console.log(t,e),function(r){return r.forceSearchTerm(""+t+" "+e+" ")}},reset:function(){return function(t){return t.reset()}}},t.Bar=function(){function e(e){this.el=e,this.el=$(this.el),this.searchField=this.el.find("input.search"),this.resultsEl=this.el.find(".downpour"),this.query=new t.Query(this,this.searchTerm()),this.results=[],this.lastSearch="",this.bindEvents(),this.currentResultIndex=0,this.focusSearchField(),this.updateTimer=null}return e.prototype.bindEvents=function(){var t=this;return this.searchField.on("keyup",function(){return t.considerUpdate()}),this.searchField.on("change",function(){return t.considerUpdate()}),Mousetrap.bind("up",function(){return t.moveUp(),!1}),Mousetrap.bind("down",function(){return t.moveDown(),!1}),Mousetrap.bind(["right","enter","tab"],function(){return t.triggerAction(),!1})},e.prototype.focusSearchField=function(){var t=this;return $(document).ready(function(){return t.searchField.focus()})},e.prototype.forceSearchTerm=function(t){return this.searchField.val(t),this.update(!0)},e.prototype.reset=function(){return forceSearchTerm("")},e.prototype.searchTerm=function(){return this.searchField.val()},e.prototype.result=function(t){return this.results.push(t),this.resultsEl.append(t.render()),this.updateSelection(),this.updateHeight(),this.el.addClass("has-results")},e.prototype.considerUpdate=function(){var t=this;return this.updateTimer&&clearTimeout(this.updatetimer),this.searchTerm().split(" ")>1?setTimeout(function(){return t.update()},300):this.update()},e.prototype.update=function(e){return null==e&&(e=!1),this.updateTimer=null,this.searchTerm()===this.activeSearch&&e===!1?!0:(this.wipe(),this.activeSearch=this.searchTerm(),this.query=new t.Query(this,this.searchTerm()),this.query.run(),!0)},e.prototype.wipe=function(){return this.results=[],this.currentResultIndex=0,this.query.cancel(),this.resultsEl.html(""),this.el.removeClass("has-results"),this.updateHeight()},e.prototype.moveUp=function(){return 0!==this.currentResultIndex?(this.currentResultIndex--,this.updateSelection()):void 0},e.prototype.moveDown=function(){return this.currentResultIndex<this.results.length-1?(this.currentResultIndex++,this.updateSelection()):void 0},e.prototype.updateSelection=function(){var t;return t=this.resultsEl.find(".result"),t.removeClass("selected"),$(t.get(this.currentResultIndex)).addClass("selected")},e.prototype.updateHeight=function(){var t,e,r,n,i;for(e=0,i=this.resultsEl.children(),r=0,n=i.length;n>r;r++)t=i[r],e+=$(t).outerHeight();return this.resultsEl.height(e)},e.prototype.triggerAction=function(){var t;return(t=this.results[this.currentResultIndex])?t.triggerAction(this):void 0},e}(),e=function(){var e,r,n,i,o;e={},o=t.actions,i=function(t){return e[t]='function() { return {name:"'+t+'", args:Array.prototype.slice.apply(arguments)} }'};for(n in o)r=o[n],i(n);return e},t.BOLT_API=WWRPC.defineProtocol({command:WWRPC.pass(function(){return this.command}),result:WWRPC.remote(function(t){return this.result(t)}),actions:e()}),t.Bolt=function(){function e(t,e){this.id=t,this.code=e,this.worker=null,this.metadata={},this.processMetadata(),this.stripCode()}return e.prototype.getKeyword=function(){return this.metadata.keyword},e.prototype.processMetadata=function(){var t,e,r,n,i,o,s;for(s=this.code.split(/\n/g),i=0,o=s.length;o>i;i++){if(e=s[i],r=e.match(/^\/\/\s+(\w+):\s?(.+?)$/),!r)return;t=r[1],n=r[2],this.set(t,n)}},e.prototype.set=function(t,e){return this.metadata[t]=e},e.prototype.process=function(e){return e.command.keyword===this.getKeyword()?this.run(e):e.result({title:this.metadata.name,description:this.metadata.description,action:t.actions.fillKeyword(this.metadata.keyword)})},e.prototype.stripCode=function(){return this.code=this.code.replace(/^(\n|\/\/.+?\n)/gm,"")},e.prototype.wrappedCode=function(){return"(function() {\n"+this.code+"\n})"},e.prototype.run=function(e){return this.worker=WWRPC.spawnWorker(t.BOLT_API,e),this.worker.loadCode(this.wrappedCode())},e.prototype.terminate=function(){return this.worker?(this.worker.terminate(),this.worker=null):void 0},e}(),t.Command=function(){function t(t){this.text=t,this.tokens=this.text.split(/\s+/g),this.keyword=this.tokens[0],this.hasKeyword=this.keyword&&this.keyword.length>0,this.query=this.text.replace(RegExp("^"+this.keyword+"\\s+"),""),this.hasQuery=this.query&&this.query.length>0}return t}(),t.Query=function(){function e(e,r){this.bar=e,this.command=new t.Command(r)}return e.prototype.cancel=function(){return t.terminateAll()},e.prototype.run=function(){var e,r,n,i,o,s;s=t.keywords;for(n in s)if(r=s[n],t.utils.fuzzyMatch(this.command.keyword,n))for(i=0,o=r.length;o>i;i++)e=r[i],t.bolts[e].process(this);return null},e.prototype.result=function(e){return this.bar.result(new t.Result(e))},e}(),t.Result=function(){function e(e){this.data=null!=e?e:{},"object"==typeof this.data.action&&(console.log(this.data.action),this.data.action=t.actions[this.data.action.name].apply(this,this.data.action.args))}return e.prototype.render=function(){return t.Template.render("result",this.data)},e.prototype.triggerAction=function(t){return"function"==typeof this.data.action?this.data.action.call(this,t):void 0},e}(),t.Template={CACHE:{},render:function(e,r){var n;return n=t.Template.get(e),n(r)},get:function(e){return t.Template.CACHE[e]||t.Template.compile(e)},compile:function(e){var r;return r=$("#"+e+"-template").html(),t.Template.CACHE[e]=Handlebars.compile(r),t.Template.CACHE[e]}}}).call(this);