(function(){var t,e;window.Storm=t={},t.bolts={},t.keywords={},t.init=function(e){var r;return r=URI(window.location.href).query(!0),new t.Bar($(e),{query:r.q}),t.loadAllFromIndex()},t.maybeInstall=function(e){return t.isInstalled(t.idFromURL(e))?void 0:t.install(e)},t.install=function(e){return console.log("INSTALL "+e),0===e.search(/^https?:\/\//i)?$.getJSON("http://anyorigin.com/get?callback=?&url="+e,function(r){return t.load(e,r.contents,{isPrivileged:!1,isInstall:!0})}):$.get(e,null,function(r){return t.load(e,r,{isPrivileged:!0,isInstall:!0})},"text")},t.idFromURL=function(t){return""+CryptoJS.SHA1(t)},t.load=function(e,r,n){var i;return null==n&&(n={}),i=new t.Bolt(e,r,n.isPrivileged||!1),t.register(i,n.isInstall||!1),n.isInstall&&i.install(),i},t.register=function(e,r){return null==r&&(r=!1),t.bolts[e.id]=e,t.keywords[e.getKeyword()]=t.keywords[e.getKeyword()]||[],-1===$.inArray(e.id,t.keywords[e.getKeyword()])&&t.keywords[e.getKeyword()].push(e.id),r&&t.addToIndex(e),e},t.addToIndex=function(e){var r;return t.store.set(["bolt",e.id],{url:e.url,isPrivileged:e.isPrivileged,source:e.source}),r=t.store.get("bolts",{}),r.installed=r.installed||[],-1===$.inArray(e.id,r.installed)&&r.installed.push(e.id),t.store.set("bolts",r)},t.loadAllFromIndex=function(){var e,r,n,i,o,s;if(r=t.store.get("bolts",{}),r.installed){for(o=r.installed,s=[],n=0,i=o.length;i>n;n++)e=o[n],s.push(t.loadFromIndex(e));return s}},t.loadFromIndex=function(e){var r;return(r=t.store.get(["bolt",e]))?t.load(r.url,r.source,{isInstall:!1,isPrivileged:r.isPrivileged}):void 0},t.isInstalled=function(e){var r;return r=t.store.get("bolts",{}),r.installed?-1!==$.inArray(e,r.installed):!1},t.terminateAll=function(){var e,r,n,i;n=t.bolts,i=[];for(r in n)e=n[r],i.push(e.terminate());return i},t.utils={prefixMatch:function(t,e){return 0===e.search(RegExp("^"+t,"i"))},fuzzyMatch:function(t,e,r){return null==r&&(r=0),e.score(t)>r}},t.actions={repeat:function(){return function(t){return t.update(!0)}},open:function(t){return function(){return window.open(t)}},fill:function(t){return function(e){return e.forceSearchTerm(t)}},fillKeyword:function(t){return function(e){return e.forceSearchTerm(t+" ")}},fillCommand:function(t,e){return function(r){return r.forceSearchTerm(""+t+" "+e+" ")}},reset:function(){return function(t){return t.reset()}},ignore:function(){return function(){return null}},install:function(e){return function(r){return this.isPrivileged?(t.install(e),r.reset()):void 0}}},t.Bar=function(){function e(e,r){var n=this;this.el=e,this.options=null!=r?r:{},this.el=$(this.el),this.searchField=this.el.find("input.search"),this.resultsEl=this.el.find(".downpour"),this.query=new t.Query(this,this.searchTerm()),this.results=[],this.lastSearch="",this.bindEvents(),this.currentResultIndex=0,this.updateTimer=null,setTimeout(function(){return n.onLoad()},1e3)}return e.prototype.onLoad=function(){return this.options.query&&this.forceSearchTerm(this.options.query),this.bindEvents(),this.focusSearchField()},e.prototype.bindEvents=function(){var t=this;return this.searchField.on("keyup",function(){return t.considerUpdate()}),this.searchField.on("change",function(){return t.considerUpdate()}),Mousetrap.bind("up",function(){return t.moveUp(),!1}),Mousetrap.bind("down",function(){return t.moveDown(),!1}),Mousetrap.bind(["right","enter","tab"],function(){return t.triggerAction(),!1})},e.prototype.focusSearchField=function(){var t=this;return $(document).ready(function(){return t.searchField.focus()})},e.prototype.forceSearchTerm=function(t){return this.searchField.val(t),this.update(!0)},e.prototype.reset=function(){return this.forceSearchTerm("")},e.prototype.searchTerm=function(){return this.searchField.val()},e.prototype.result=function(t){return this.results.push(t),this.resultsEl.append(t.render()),this.updateSelection(),this.updateHeight(),this.el.addClass("has-results")},e.prototype.considerUpdate=function(){var t=this;return this.updateTimer&&clearTimeout(this.updatetimer),this.searchTerm().split(" ")>1?setTimeout(function(){return t.update()},300):this.update()},e.prototype.update=function(e){return null==e&&(e=!1),this.updateTimer=null,this.searchTerm()===this.activeSearch&&e===!1?!0:(this.wipe(),this.activeSearch=this.searchTerm(),this.query=new t.Query(this,this.searchTerm()),this.query.run(),!0)},e.prototype.wipe=function(){return this.results=[],this.currentResultIndex=0,this.query.cancel(),this.resultsEl.html(""),this.el.removeClass("has-results"),this.updateHeight()},e.prototype.moveUp=function(){return 0!==this.currentResultIndex?(this.currentResultIndex--,this.updateSelection()):void 0},e.prototype.moveDown=function(){return this.currentResultIndex<this.results.length-1?(this.currentResultIndex++,this.updateSelection()):void 0},e.prototype.updateSelection=function(){var t;return t=this.resultsEl.find(".result"),t.removeClass("selected"),$(t.get(this.currentResultIndex)).addClass("selected")},e.prototype.updateHeight=function(){var t,e,r,n,i;for(e=0,i=this.resultsEl.children(),r=0,n=i.length;n>r;r++)t=i[r],e+=$(t).outerHeight();return this.resultsEl.height(e)},e.prototype.triggerAction=function(){var t;return(t=this.results[this.currentResultIndex])?t.triggerAction(this):void 0},e}(),e=function(){var e,r,n,i,o;e={},o=t.actions,i=function(t){return e[t]='function() { return {name:"'+t+'", args:Array.prototype.slice.apply(arguments)} }'};for(n in o)r=o[n],i(n);return e},t.BOLT_API=WWRPC.defineProtocol({log:WWRPC.remote(function(t){return console.log(t)}),utils:{sanitize:WWRPC.local(function(t){return t.replace(/<\/?[a-z0-9]+>/gi,"")}),truncate:WWRPC.local(function(t,e){return t.slice(0,e)}),prefixMatch:WWRPC.local(t.utils.prefixMatch)},command:WWRPC.pass(function(){return this.query.command}),meta:WWRPC.pass(function(){return this.bolt.metadata}),bolts:WWRPC.pass(function(){var e,r,n,i;n={installed:{}},i=t.bolts;for(r in i)e=i[r],n.installed[e.id]=e.metadata;return n}),result:WWRPC.remote(function(t){return this.query.result(t,this.bolt.isPrivileged)}),actions:e(),http:{getJSON:WWRPC.remote(function(t,e){return $.getJSON(t,function(t){return e(t)})})},options:WWRPC.local(function(t){var e,r,n,i,o;if(this._tokenDepth=(this._tokenDepth||0)+1,n=command.tokens[this._tokenDepth],command.hasQuery){i=[];for(e in t)r=t[e],n===e?i.push(r.action()):utils.prefixMatch(command.tokens[1],e)?i.push(result({title:r.title,description:r.description,action:actions.fillCommand(command.keyword,e)})):i.push(void 0);return i}o=[];for(e in t)r=t[e],o.push(result({title:r.title,description:r.description,action:actions.fillCommand(command.keyword,e)}));return o}),bolt:{run:WWRPC.local(function(t){return this._run=t}),install:WWRPC.local(function(t){return this._install=t}),uninstall:WWRPC.local(function(t){return this._uninstall=t})}}),t.Bolt=function(){function e(e,r,n){this.url=e,this.source=r,this.isPrivileged=null!=n?n:!1,this.id=t.idFromURL(this.url),this.code=this.source,this.worker=null,this.metadata={},this.processMetadata(),this.stripCode(),this.compile()}return e.prototype.getKeyword=function(){return this.metadata.keyword},e.prototype.processMetadata=function(){var t,e,r,n,i,o,s;for(s=this.code.split(/\n/g),i=0,o=s.length;o>i;i++){if(e=s[i],r=e.match(/^(\/\/|#)\s+(\w+):\s?(.+?)$/),!r)return;t=r[2],n=r[3],this.set(t,n)}},e.prototype.set=function(t,e){return this.metadata[t]=e},e.prototype.process=function(e){return e.command.hasKeyword&&e.command.keyword===this.getKeyword()?this.run(e):e.result({title:this.metadata.name,description:this.metadata.description,action:t.actions.fillKeyword(this.metadata.keyword)})},e.prototype.stripCode=function(){return this.code=this.code.replace(/^(\n|\/\/.+?\n)/gm,"")},e.prototype.compile=function(){return this.url.search(/\.coffee$/i)>0&&(this.code=CoffeeScript.compile(this.code)),this.code="(function() {\n"+this.code+"\n})"},e.prototype.install=function(){return this.execute("install")},e.prototype.uninstall=function(){return this.execute("uninstall")},e.prototype.run=function(t){return this.execute("run",t)},e.prototype.execute=function(e,r){return null==r&&(r={}),this.worker=WWRPC.spawnWorker(t.BOLT_API,{query:r,bolt:this}),this.worker.loadCode(this.code),this.worker.loadCode("(function() { if(typeof bolt._"+e+" === 'function') bolt._"+e+"() })")},e.prototype.terminate=function(){return this.worker?(this.worker.terminate(),this.worker=null):void 0},e}(),t.Command=function(){function t(t){this.text=t,this.tokens=this.text.split(/\s+/g),this.keyword=this.tokens[0],this.hasKeyword=this.text.search(/\s/)>0,this.query=this.text.replace(RegExp("^"+this.keyword+"\\s+"),""),this.hasQuery=this.query&&this.query.length>0}return t}(),t.Query=function(){function e(e,r){this.bar=e,this.command=new t.Command(r)}return e.prototype.cancel=function(){return t.terminateAll()},e.prototype.run=function(){var e,r,n,i,o,s;s=t.keywords;for(n in s)if(r=s[n],t.utils.fuzzyMatch(this.command.keyword,n))for(i=0,o=r.length;o>i;i++)e=r[i],t.bolts[e].process(this);return null},e.prototype.result=function(e,r){return null==r&&(r=!1),this.bar.result(new t.Result(e,r))},e}(),t.Result=function(){function e(e,r){this.data=null!=e?e:{},this.isPrivileged=null!=r?r:!1,"object"==typeof this.data.action&&(this.data.action=t.actions[this.data.action.name].apply(this,this.data.action.args))}return e.prototype.render=function(){return t.Template.render("result",this.data)},e.prototype.triggerAction=function(t){return"function"==typeof this.data.action?this.data.action.call(this,t):void 0},e}(),t.store={get:function(e,r){return null==r&&(r=null),$.jStorage.get(t.store.makeKey(e),r)},set:function(e,r){return $.jStorage.set(t.store.makeKey(e),r)},destroy:function(e){return $.jStorage.deleteKey(t.store.makeKey(e))},makeKey:function(t){return"string"==typeof t?t:t.join(":")}},t.Template={CACHE:{},render:function(e,r){var n;return n=t.Template.get(e),n(r)},get:function(e){return t.Template.CACHE[e]||t.Template.compile(e)},compile:function(e){var r;return r=$("#"+e+"-template").html(),t.Template.CACHE[e]=Handlebars.compile(r),t.Template.CACHE[e]}}}).call(this);